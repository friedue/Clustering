#!/bin/sh
# This script takes a bed-file of regions and uses heatmapper3.py to generate a signal matrix for each ChIP sample. Then, the signals are clustered according to distance and linkage methods indicated in the calling of the script.
# usage example: sh clustering1.sh	AllPeaks_merged		log2ratio	euclidean	ward	new
###########################################################################################################
#${1} bed-file with merged peak regions but _without_ .bed ending! e.g. RandSample_AllPeaks_merged - see below for hints on how to generate such a file
#${2} signal type, either one of: "log2ratio-noGC,"difference" (GC-corrected), "difference-InputScale","log2ratio-GC"
#${3} distance method; This must be one of "pearson", "euclidean", "maximum", "manhattan", "canberra", "binary" or "minkowski"
#${4} linkage method; one of "ward", "single", "complete", "average", "mcquitty", "median" or "centroid"
#${5} whether to use an existing distance matrix (R-object) or create a new distance matrix: indicate Robj path or "new"
###########################################################################################################
## output files:
# peakMatrix_Complete_${1}_${2}.tab --> signal matrix
# peakMatrix_ChIPsignals_HMcollage_${1}_${2}.png --> visualizes individual signals for the regions taken into account for the signal matrix
# *dist.Robj --> R-object that contains the distances matrix
# *hclust.Robj --> R-object that contains the results of the hierarchical clustering
# dendrogram*png --> visualization of the hiearchical clustering
###########################################################################################################
## obtaining a bed-file of merged peaks - here's an example:
#cat ../../data/Tomek/peaks/MCRS1_merge_CAB.bed ../../data/Tomek/peaks/MOF_merge_CAB.bed ../../data/Tomek/peaks/MSL1_merge_CAB.bed ../../data/Tomek/peaks/MSL2_merge_CAB.bed ../../data/Tomek/peaks/NSL3_merge_CAB.bed > AllPeaks.bed
#/package/BEDTools-Version-2.12.0/bin/mergeBed -i AllPeaks.bed > AllPeaks_merged.bed
##########################################################################################################
PEAKS=AllPeaks_mlES_mlNPC_merged.bed
APPENDIX=50bp_mlES_mlNPC
SIGNALTYPE=log2ratio
SIGNALMATRIX=${SIGNALTYPE}_${APPENDIX}.tab
DISTANCE=euclidean
CLUSTER=ward

#1. signalMatrix generation mlES
CELL=mlES
echo "producing signal matrix for ${CELL}"
for CHIP in MSL1 MSL2 MOF MCRS1 NSL3
do
SIGNAL=/data/projects/akhtar/bigwig/Tomek_mm9/log2ratio_InputScaled/log2_${CHIP}merge_${CELL}_inputScaled.bw

/data/projects/ramirez/tools/IETools/bin/heatmapper binning -S ${SIGNAL} -R ${PEAKS} -F bigwig -w 50 -m 1000 -a 100 -b 100 --regionsLabel "peak regions" --sortRegions no --colorMap Spectral_r --missingDataAsZero -T "${CHIP}merge_${CELL} unclust. ${SIGNALTYPE}" --startLabel "peak start" --endLabel "peak end" --outFileName peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.png --outFileNameMatrix peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.tab
echo peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.tab >> filelist
done

#1.2 signalMatrix generation mlNPC
CELL=mlNPC
echo "producing signal matrix for ${CELL}"
for CHIP in MSL2 MOF NSL3
do
SIGNAL=/data/projects/akhtar/bigwig/Tomek_mm9/log2ratio_noGCcorrect/log2_${CHIP}merge_${CELL}_noGCcorrect.bw
/data/projects/ramirez/tools/IETools/bin/heatmapper binning -S ${SIGNAL} -R ${PEAKS} -F bigwig -w 50 -m 1000 -a 100 -b 100 --regionsLabel "peak regions" --sortRegions no --colorMap Spectral_r --missingDataAsZero -T "${CHIP}merge_${CELL} unclust. ${SIGNALTYPE}" --startLabel "peak start" --endLabel "peak end" --outFileName peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.png --outFileNameMatrix peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.tab
echo peakMatrix_${SIGNALTYPE}_${CHIP}merge_${CELL}_${APPENDIX}.tab >> filelist
done

#2. signal Matrix rank transformation
echo "performing signal matrix rank transformation"
/data/projects/muehlpfordt/scripts/Cluster0_matrixProcessing.R filelist ${SIGNALTYPE}_${APPENDIX}
3. hclust
echo "performing hclust"
/data/projects/muehlpfordt/scripts/Cluster1_computeHierarchicalClustering_FM_2013-03-11.R ${SIGNALMATRIX} ${DISTANCE} ${CLUSTER} ${SIGNALTYPE} new

4. dendrogram pruning
echo "performing dendrogram pruning"
for i in 3 4 5 6
do
/data/projects/muehlpfordt/scripts/Cluster2a_split_in_groups_plot_dendrogram_FM_outputUnsorted.R ${SIGNALMATRIX} hclust_${SIGNALTYPE}_${DISTANCE}_${CLUSTER}.Robj ${PEAKS} ${i} clusters_${i}.bed dendrogram_${i}.pdf summary
/package/BEDTools/bin/bedtools shuffle -i ${PEAKS} -g /data/projects/misc/genomes/Mm/mm9/sizes/mm9_no_random.genome | head -2500 >> clusters_${i}.bed 
CELL=mlES
for CHIP in MOF MSL1 MSL2 MCRS1 NSL3
do
SIGNAL=/data/projects/akhtar/bigwig/Tomek_mm9/log2ratio_InputScaled/log2_${CHIP}merge_${CELL}_inputScaled.bw
python /data/projects/ramirez/tools/heatmapper/heatmapper3.py reference-point -w 50 -a 2000 -b 2000 -S ${SIGNAL} -R clusters_${i}.bed -F bigwig --regionsLabel "random" --referencePoint center --refPointLabel "peak center" --colorMap RdYlBu --missingDataAsZero -T "${i} Clusters: ${CHIP}merge_${CELL} signal" --outFileName ${i}Clusters_merge_${CELL}_${CHIP}.png --sortRegions descend --whatToShow "heatmap and colorbar"
done
CELL=mlNPC
for CHIP in MSL2 MOF NSL3
do
SIGNAL=/data/projects/akhtar/bigwig/Tomek_mm9/log2ratio_noGCcorrect/log2_${CHIP}merge_${CELL}_noGCcorrect.bw
python /data/projects/ramirez/tools/heatmapper/heatmapper3.py reference-point -w 50 -a 2000 -b 2000 -S ${SIGNAL} -R clusters_${i}.bed -F bigwig --regionsLabel "random" --referencePoint center --refPointLabel "peak center" --colorMap RdYlBu --missingDataAsZero -T "${i} Clusters: ${CHIP}merge_${CELL} signal" --outFileName ${i}Clusters_merge_${CELL}_${CHIP}.png --sortRegions descend --whatToShow "heatmap and colorbar"
done
montage ${i}Clusters_merge_mlES_MOF.png ${i}Clusters_merge_mlES_MSL1.png ${i}Clusters_merge_mlES_MSL2.png ${i}Clusters_merge_mlES_NSL3.png ${i}Clusters_merge_mlES_MCRS1.png ${i}Clusters_merge_mlNPC_MOF.png ${i}Clusters_merge_mlNPC_MSL2.png ${i}Clusters_merge_mlNPC_NSL3.png -tile x1 -geometry +0.1+0.1 ${i}Clusters_mlES_mlNPC_${SIGNALTYPE}.png
done
